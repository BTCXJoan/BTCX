<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>BTCX Panel</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
body {
  background:#0b0f1a;
  color:white;
  font-family:Arial;
  text-align:center;
  padding:40px;
}

.logo { width:120px; margin-bottom:10px; }

.panel {
  max-width:650px;
  margin:20px auto;
  background:#111827;
  padding:20px;
  border-radius:10px;
}

.button {
  margin:10px;
  padding:14px;
  background:#2563eb;
  border:none;
  color:white;
  border-radius:8px;
  cursor:pointer;
  display:block;
  width:300px;
  margin-left:auto;
  margin-right:auto;
  text-decoration:none;
}

.priceBox {
  font-size:26px;
  margin:20px 0;
}
</style>
</head>

<body>

<img src="btcx-logo.png" class="logo">

<h2>BTCX Dashboard</h2>

<div id="btcPrice" class="priceBox">Cargando precio...</div>

<div style="max-width:650px;margin:auto;">
<iframe src="https://s.tradingview.com/widgetembed/?symbol=BITSTAMP:BTCUSD&interval=D&theme=dark"
width="100%" height="300"></iframe>
</div>

<div class="panel">
<h3>Estado de tu staking</h3>
<div id="userData">Cargando...</div>
</div>

<h3>Biblioteca BTCX</h3>

<a class="button" href="capitulo1.html">Capítulo 1 — Qué es Bitcoin</a>
<a class="button" href="capitulo2.html">Capítulo 2 — Por qué existe</a>
<a class="button" href="capitulo3.html">Capítulo 3 — Custodia</a>

<br>
<a href="index.html" style="color:white;">Cerrar sesión</a>

<script>

const stakingAddress="0xFc9016F9153D0a7e9A09DDca7Ad756F9485cEcbc";

const stakingABI=[
 "function hasAccess(address user) view returns(bool)",
 "function stakes(address user) view returns(uint256,uint256)",
 "function totalStaked() view returns(uint256)"
];

async function loadBTC(){
 const r=await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd");
 const d=await r.json();
 document.getElementById("btcPrice").innerHTML="BTC/USD: $"+d.bitcoin.usd.toLocaleString();
}

async function loadUser(){

 if(!window.ethereum){
   document.getElementById("userData").innerHTML="MetaMask no detectado";
   return;
 }

 const provider=new ethers.providers.Web3Provider(window.ethereum);
 const signer=provider.getSigner();
 const address=await signer.getAddress();

 const contract=new ethers.Contract(stakingAddress,stakingABI,provider);

 const access=await contract.hasAccess(address);

 if(!access){
   document.getElementById("userData").innerHTML="No tienes acceso activo";
   return;
 }

 const stake=await contract.stakes(address);
 const total=await contract.totalStaked();

 const amount=ethers.utils.formatUnits(stake[0],18);
 const totalFormatted=ethers.utils.formatUnits(total,18);

 document.getElementById("userData").innerHTML=
 "BTCX en staking: "+amount+
 "<br>Total BTCX bloqueados: "+totalFormatted;
}

loadBTC();
loadUser();

</script>

</body>
</html>
